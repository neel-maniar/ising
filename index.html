<!DOCTYPE html>
<html>
<head>
  <title>Ising Model with Web Worker</title>
  <style>
    canvas { image-rendering: pixelated; border: 1px solid black; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>
<canvas id="graphCanvas" width="400" height="100" style="border:1px solid black; display:block; margin-top:10px;"></canvas>


<div id="controls">
  <label>Temperature: <span id="tempVal" style="display:inline-block; width:20px; text-align:right;">2.5</span></label>
  <input type="range" id="temp" min="0.1" max="5" step="0.1" value="2.5">
  
  <label style="margin-left:20px;">Magnetization: 
    <span id="magVal" style="display:inline-block; width:50px; text-align:right;">0</span>
  </label>
  
  <label style="margin-left:20px;">Speed: <span id="speedVal" style="display:inline-block; width:30px; text-align:right;">1</span> steps/frame</label>
  <input type="range" id="speed" min="1" max="20" step="1" value="1">
</div>

<script>
const L = 300; // lattice size
const canvas = document.getElementById("canvas");
canvas.width = L;
canvas.height = L;
const ctx = canvas.getContext("2d");

const graphCanvas = document.getElementById("graphCanvas");
const gCtx = graphCanvas.getContext("2d");
const maxPoints = graphCanvas.width; // 1 pixel per frame
let magHistory = []; // array of past magnetization values

const speedSlider = document.getElementById("speed");
const speedVal = document.getElementById("speedVal");

speedSlider.addEventListener("input", () => {
  const steps = parseInt(speedSlider.value);
  speedVal.textContent = steps;
  worker.postMessage({ type: "setSpeed", steps: steps });
});

// Create Web Worker
const worker = new Worker("worker.js");

// Send initial parameters
worker.postMessage({ type: "init", L: L, beta: 1/2.5 });

// Handle updates from worker
worker.onmessage = (e) => {
  if (e.data.type === "frame") {
    drawLattice(e.data.lattice);
    const M = e.data.mag;
    document.getElementById("magVal").textContent = M.toFixed(2);

    // update history
    magHistory.push(M);
    if (magHistory.length > maxPoints) magHistory.shift(); // keep latest points
    drawGraph();

  }
};

// Draw lattice on canvas
function drawLattice(lattice) {
  const img = ctx.createImageData(L, L);
  for (let i = 0; i < L; i++) {
    for (let j = 0; j < L; j++) {
      const idx = (i*L + j)*4;
      const spin = lattice[i*L + j];  // flattened index
      const color = spin > 0 ? 255 : 0;
      img.data[idx] = color;
      img.data[idx+1] = color;
      img.data[idx+2] = color;
      img.data[idx+3] = 255;
    }
  }
  ctx.putImageData(img, 0, 0);
}

function drawGraph() {
  gCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
  gCtx.beginPath();
  gCtx.moveTo(0, graphCanvas.height/2 - magHistory[0]*(graphCanvas.height/2));

  for (let i = 1; i < magHistory.length; i++) {
    const x = i;
    const y = graphCanvas.height/2 - magHistory[i]*(graphCanvas.height/2);
    gCtx.lineTo(x, y);
  }
  gCtx.strokeStyle = "red";
  gCtx.lineWidth = 1;
  gCtx.stroke();
}

// Temperature slider
const tempSlider = document.getElementById("temp");
const tempVal = document.getElementById("tempVal");

tempSlider.addEventListener("input", () => {
  const T = parseFloat(tempSlider.value);
  tempVal.textContent = T;
  const beta = 1 / T;
  worker.postMessage({ type: "setBeta", beta: beta });
});
</script>

</body>
</html>
